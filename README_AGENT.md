# Agent.py 智能代码代理系统

## 📋 项目概述

`agent.py` 是一个基于大语言模型（LLM）的智能代码代理系统，能够自动处理两种类型的编程任务：
- **CREATE（创建任务）**：从零开始生成完整的代码实现
- **FIX（修复任务）**：分析并修复现有代码库中的问题

系统通过工具调用、思维链推理和迭代优化，实现智能化的代码生成和问题修复。

---

## 🎯 核心功能

### 1. 任务类型识别
- 自动判断问题类型（CREATE 或 FIX）
- 根据任务类型选择不同的处理策略

### 2. 代码生成与修复
- **CREATE模式**：生成初始解决方案 → 生成测试用例 → 验证 → 失败时提取模式并重试
- **FIX模式**：使用工具链逐步分析、定位、修复问题

### 3. 多模型支持
支持以下LLM模型：
- `GLM-4.6-FP8` (默认)
- `Kimi-K2-Instruct`
- `DeepSeek-V3-0324`
- `Qwen3-Coder-480B-A35B-Instruct-FP8`

### 4. 丰富的工具集
提供9个核心工具，支持完整的代码操作流程。

---

## 🏗️ 架构设计

### 核心类结构

```
EnhancedCOT (思维链管理)
├── Action: 存储单次操作的完整信息
└── to_str(): 将思维链转换为消息格式

EnhancedToolManager (工具管理器基类)
├── tool装饰器: 自动注册和统计工具调用
├── tool_parsing: 解析工具文档生成schema
└── 错误处理机制

FixTaskEnhancedToolManager (修复任务工具管理器)
├── 继承 EnhancedToolManager
└── 实现9个具体工具方法

EnhancedNetwork (网络请求与推理)
├── make_request: 发送请求到推理网关
├── inference: 带重试的推理调用
├── parse_response: 解析LLM响应
└── 错误处理与重试机制

Utils (工具函数)
├── load_json: JSON解析（支持容错）
└── limit_strings: 字符串截断
```

---

## 🔧 主要组件详解

### 1. EnhancedCOT (思维链管理器)

**功能**：管理整个推理过程的思维链，记录每次操作。

**关键方法**：
- `add_action()`: 添加新的操作记录
- `is_thought_repeated()`: 检测是否重复调用工具
- `to_str()`: 转换为对话消息格式（保留最近N条完整观察）

**数据结构**：
```python
Action {
    next_thought: str          # 思考过程
    next_tool_name: str         # 工具名称
    next_tool_args: dict        # 工具参数
    observation: str            # 工具执行结果
    is_error: bool              # 是否错误
    raw_response: str           # 原始LLM响应
    total_attempts: int         # 总尝试次数
}
```

### 2. EnhancedToolManager (工具管理器)

**功能**：管理所有可用工具，提供统一的工具调用接口。

**核心机制**：
- `@tool` 装饰器：自动注册工具，统计调用次数和失败次数
- `tool_parsing()`: 从函数文档字符串自动生成工具schema
- 错误分类：语法错误、运行时错误、超时等11种错误类型

**工具注册流程**：
1. 扫描类方法，查找带 `@tool` 装饰器的方法
2. 解析函数签名和文档字符串
3. 生成JSON Schema格式的工具定义
4. 注册到 `TOOL_LIST` 字典

### 3. FixTaskEnhancedToolManager (修复任务工具集)

**9个核心工具**：

| 工具名称 | 功能描述 |
|---------|---------|
| `get_file_content` | 获取文件内容（支持行号范围、搜索词过滤） |
| `save_file` | 保存文件（带语法检查） |
| `search_in_all_files_content` | 全局搜索代码模式 |
| `search_in_specified_file_v2` | 在指定文件中搜索 |
| `run_repo_tests` | 运行测试套件 |
| `run_code` | 执行Python代码 |
| `apply_code_edit` | 应用代码编辑（search-replace） |
| `generate_tests` | 生成测试用例 |
| `get_approval_for_solution` | 获取解决方案批准 |
| `finish` | 完成工作流 |

**特殊功能**：
- 自动检测语法错误
- 智能合并测试类
- 生成git patch
- 排除测试文件

### 4. EnhancedNetwork (网络与推理)

**功能**：处理与LLM的通信，包括请求发送、响应解析、错误重试。

**关键方法**：

1. **`make_request()`**: 
   - 发送HTTP请求到推理网关
   - 处理超时、连接错误、HTTP错误
   - 支持OpenAI格式和自定义格式响应

2. **`inference()`**: 
   - 清理消息格式
   - 调用 `_request_next_action_with_retry()` 进行重试
   - 返回解析后的结果

3. **`parse_response()`**: 
   - 解析LLM返回的三元组格式：`next_thought`, `next_tool_name`, `next_tool_args`
   - 处理JSON解析错误
   - 支持容错解析

4. **`_request_next_action_with_retry()`**: 
   - 最多重试5次
   - 失败时切换模型
   - 根据错误类型决定是否添加到对话历史

### 5. 工作流函数

#### `fix_task_solve_workflow()` - 修复任务主流程

**流程**：
1. 初始化工具管理器和思维链
2. 构建系统提示词（包含工具文档）
3. 循环执行（最多400步）：
   - 构建消息（系统提示 + 问题描述 + 思维链历史）
   - 调用LLM获取下一步操作
   - 执行工具调用
   - 记录结果到思维链
   - 检测重复调用，增加温度/切换模型
   - 如果调用 `finish` 且测试通过，退出循环
4. 生成最终git patch

**关键机制**：
- 重复检测：如果连续两次调用相同工具，增加温度并可能切换模型
- 超时控制：全局超时和步骤限制
- 错误恢复：工具错误不会中断流程，记录后继续

#### `process_create_task()` - 创建任务主流程

**流程**：
1. 获取代码骨架（所有.py文件）
2. 温度调度策略：
   - 预热阶段（2步）：从0.1到0.6
   - 平台阶段（4步）：在0.6附近波动
   - 高温阶段（剩余）：从0.6到1.2
3. 对每个温度值：
   - 调用 `basic_approach()` 生成解决方案
   - 如果成功，返回patch
   - 如果失败，提取失败模式
4. 如果所有尝试都失败，调用 `advanced_approach()` 使用累积模式

#### `basic_approach()` - 基础方法

**流程**：
1. `generate_initial_solution()`: 生成初始代码
2. `extract_and_write_files()`: 提取并写入文件
3. `generate_single_testset()`: 生成测试用例
4. 运行测试
5. 如果失败，`extract_semantic_patterns_from_failures()` 提取模式

#### `advanced_approach()` - 高级方法

使用累积的失败模式，调用 `generate_initial_solution_with_patterns()` 重新生成。

---

## 🔄 工作流程

### CREATE任务流程

```
开始
  ↓
获取代码骨架
  ↓
温度调度循环 (最多20次)
  ├─→ 生成初始解决方案
  ├─→ 提取并写入文件
  ├─→ 生成测试用例
  ├─→ 运行测试
  │   ├─→ 通过 → 生成patch → 结束 ✅
  │   └─→ 失败 → 提取失败模式
  └─→ 继续下一个温度
  ↓
所有尝试失败
  ↓
使用累积模式调用高级方法
  ↓
生成patch → 结束
```

### FIX任务流程

```
开始
  ↓
初始化工具管理器和思维链
  ↓
构建系统提示词（包含工具文档）
  ↓
主循环 (最多400步)
  ├─→ 构建消息（系统提示 + 问题 + 思维链历史）
  ├─→ LLM推理获取下一步操作
  ├─→ 执行工具调用
  │   ├─→ get_file_content: 读取文件
  │   ├─→ search_in_all_files_content: 全局搜索
  │   ├─→ apply_code_edit: 应用编辑
  │   ├─→ run_repo_tests: 运行测试
  │   └─→ ... 其他工具
  ├─→ 记录结果到思维链
  ├─→ 检测重复调用 → 调整温度/模型
  └─→ 如果调用finish且测试通过 → 退出
  ↓
生成git patch
  ↓
结束
```

---

## 📊 图形化逻辑结构

### 系统整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      Agent 主入口                              │
│                    agent_main()                               │
└───────────────────────┬───────────────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
            ▼                       ▼
    ┌───────────────┐      ┌───────────────┐
    │  CREATE任务    │      │   FIX任务      │
    │process_create │      │process_fix    │
    └───────┬───────┘      └───────┬───────┘
            │                       │
            ▼                       ▼
    ┌───────────────┐      ┌──────────────────────┐
    │ basic_approach│      │fix_task_solve_workflow│
    └───────┬───────┘      └──────────┬───────────┘
            │                         │
            ▼                         ▼
    ┌───────────────┐      ┌──────────────────────┐
    │ 生成解决方案   │      │   EnhancedCOT         │
    │ 生成测试用例   │      │   (思维链管理)        │
    │ 运行测试      │      └──────────┬───────────┘
    └───────┬───────┘                 │
            │                         ▼
            │                 ┌──────────────────────┐
            │                 │ EnhancedNetwork       │
            │                 │ (LLM推理)            │
            │                 └──────────┬───────────┘
            │                           │
            │                           ▼
            │                 ┌──────────────────────┐
            │                 │FixTaskEnhancedTool   │
            │                 │Manager (工具执行)    │
            │                 └──────────────────────┘
            │
            └───────────────────┐
                                ▼
                        ┌───────────────┐
                        │ 生成Git Patch │
                        └───────────────┘
```

### CREATE任务详细流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    process_create_task()                      │
└───────────────────────┬───────────────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │  温度调度策略生成       │
            │  (预热→平台→高温)      │
            └───────────┬───────────┘
                        │
        ┌───────────────┴───────────────┐
        │  循环: 每个温度值 (最多20次)   │
        └───────────────┬───────────────┘
                        │
            ┌───────────┴───────────┐
            ▼                       ▼
    ┌───────────────┐      ┌───────────────┐
    │basic_approach │      │ 提取失败模式   │
    └───────┬───────┘      └───────┬───────┘
            │                       │
    ┌───────┴────────┐              │
    │                │              │
    ▼                ▼              │
┌─────────┐    ┌─────────┐         │
│生成初始  │    │生成测试 │         │
│解决方案  │───▶│用例     │         │
└────┬────┘    └────┬────┘         │
     │              │              │
     └──────┬───────┘              │
            │                      │
            ▼                      │
    ┌───────────────┐              │
    │   运行测试     │              │
    └───────┬───────┘              │
            │                      │
    ┌───────┴───────┐              │
    │               │              │
    ▼               ▼              │
┌─────────┐    ┌─────────┐         │
│测试通过  │    │测试失败  │─────────┘
│返回patch│    │记录模式  │
└─────────┘    └─────────┘
                        │
                        ▼
        ┌───────────────────────────┐
        │  所有尝试失败              │
        │  → advanced_approach()    │
        │  → 使用累积模式重新生成     │
        └───────────────────────────┘
```

### FIX任务详细流程图

```
┌─────────────────────────────────────────────────────────────┐
│              fix_task_solve_workflow()                       │
└───────────────────────┬───────────────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │  初始化                │
            │  - EnhancedCOT         │
            │  - ToolManager        │
            │  - 系统提示词          │
            └───────────┬───────────┘
                        │
        ┌───────────────┴───────────────┐
        │  主循环 (最多400步)            │
        └───────────────┬───────────────┘
                        │
            ┌───────────┴───────────┐
            │  构建消息               │
            │  - 系统提示             │
            │  - 问题描述             │
            │  - 思维链历史           │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  EnhancedNetwork       │
            │  .inference()         │
            │  (LLM推理)             │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  解析响应               │
            │  - next_thought        │
            │  - next_tool_name      │
            │  - next_tool_args      │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  执行工具               │
            │  ┌─────────────────┐  │
            │  │ get_file_content│  │
            │  │ search_*        │  │
            │  │ apply_code_edit │  │
            │  │ run_repo_tests  │  │
            │  │ generate_tests │  │
            │  │ ...             │  │
            │  └─────────────────┘  │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  记录到思维链           │
            │  cot.add_action()     │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  检测重复调用           │
            │  - 增加温度            │
            │  - 切换模型            │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  检查完成条件           │
            │  - finish工具调用      │
            │  - 测试通过            │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  继续循环 或 退出      │
            └───────────┬───────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │  生成Git Patch         │
            └───────────────────────┘
```

### 工具调用关系图

```
┌─────────────────────────────────────────────────────────────┐
│              FixTaskEnhancedToolManager                      │
└───────────────────────┬───────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ 文件操作工具   │ │ 代码搜索工具   │ │ 测试工具       │
├───────────────┤ ├───────────────┤ ├───────────────┤
│get_file_content│ │search_in_all  │ │run_repo_tests │
│save_file      │ │_files_content  │ │run_code       │
│               │ │search_in_      │ │generate_tests │
│               │ │specified_file  │ │               │
│               │ │_v2            │ │               │
└───────────────┘ └───────────────┘ └───────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐              ┌───────────────┐
│ 代码编辑工具   │              │ 工作流工具     │
├───────────────┤              ├───────────────┤
│apply_code_edit│              │get_approval_  │
│               │              │for_solution   │
│               │              │finish         │
└───────────────┘              └───────────────┘
```

### LLM推理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    EnhancedNetwork                            │
└───────────────────────┬───────────────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │   inference()          │
            │   (清理消息格式)        │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │_request_next_action_   │
            │with_retry()           │
            │(最多重试5次)           │
            └───────────┬───────────┘
                        │
        ┌───────────────┴───────────────┐
        │  循环: 每次尝试                │
        └───────────────┬───────────────┘
                        │
            ┌───────────┴───────────┐
            │  make_request()        │
            │  (发送HTTP请求)        │
            └───────────┬───────────┘
                        │
            ┌───────────┴───────────┐
            │  is_valid_response()  │
            │  (验证响应)            │
            └───────────┬───────────┘
                        │
        ┌───────────────┴───────────────┐
        │  有效?                          │
        └───────────────┬───────────────┘
            │           │
            ▼           ▼
    ┌───────────┐ ┌───────────┐
    │  是       │ │  否       │
    └─────┬─────┘ └─────┬─────┘
          │             │
          │     ┌───────┴───────┐
          │     │ 记录错误       │
          │     │ 切换模型?      │
          │     │ 添加到历史?    │
          │     │ 延迟重试       │
          │     └───────┬───────┘
          │             │
          └──────┬──────┘
                 │
                 ▼
        ┌─────────────────┐
        │  parse_response │
        │  (解析三元组)    │
        └─────────┬───────┘
                  │
          ┌───────┴───────┐
          │  返回结果      │
          │  - next_thought│
          │  - next_tool_  │
          │    name        │
          │  - next_tool_  │
          │    args        │
          └───────────────┘
```

---

## 🔑 关键设计模式

### 1. 装饰器模式
- `@tool` 装饰器自动注册工具并统计调用

### 2. 策略模式
- CREATE和FIX使用不同的处理策略
- 温度调度策略

### 3. 模板方法模式
- `EnhancedToolManager` 定义工具框架
- `FixTaskEnhancedToolManager` 实现具体工具

### 4. 观察者模式
- 思维链记录所有操作历史

### 5. 重试模式
- 网络请求、JSON解析、代码生成都有重试机制

---

## ⚙️ 配置参数

### 环境变量
- `SANDBOX_PROXY_URL`: 推理网关地址（默认: `http://sandbox_proxy`）
- `AGENT_TIMEOUT`: 任务超时时间（默认: 2200秒）
- `RUN_ID`: 运行ID（用于日志追踪）
- `REPO_PATH`: 仓库路径（默认: `/sandbox/repo`）

### 常量配置
- `MAX_FIX_TASK_STEPS`: 修复任务最大步数（400）
- `BASIC_APPROACH_MAX_RETRIES`: 基础方法最大重试次数（20）
- `MAX_INFERENCE_RETRIES`: 推理最大重试次数（10）
- `COT_OBSERVATIONS_TO_KEEP`: 思维链保留的观察数量（30）

---

## 📝 使用示例

### 基本使用

```python
from agent import agent_main

input_dict = {
    "problem_statement": "修复用户登录功能的bug"
}

result = agent_main(input_dict, repo_dir="./my_repo")
print(result)  # Git patch格式的代码变更
```

### 环境设置

```bash
export SANDBOX_PROXY_URL="http://localhost:8000"
export AGENT_TIMEOUT="3600"
export RUN_ID="run_12345"
```

---

## 🎨 特色功能

1. **智能重复检测**: 自动检测重复的工具调用，通过增加温度和切换模型来打破循环
2. **模式提取**: 从测试失败中提取语义模式，指导后续代码生成
3. **温度调度**: CREATE任务使用温度调度策略，平衡探索和利用
4. **多模型支持**: 支持4种不同的LLM模型，失败时自动切换
5. **语法检查**: 所有代码编辑都会进行语法检查，防止引入错误
6. **智能测试合并**: 自动检测并合并测试类，保持代码整洁

---

## 🔍 错误处理

系统定义了11种错误类型：
1. `SYNTAX_ERROR`: 语法错误
2. `RUNTIME_ERROR`: 运行时错误
3. `TIMEOUT`: 超时
4. `FILE_NOT_FOUND`: 文件未找到
5. `SEARCH_TERM_NOT_FOUND`: 搜索词未找到
6. `UNKNOWN`: 未知错误
7. `THIRD_PARTY_DEPENDENCIES`: 第三方依赖错误
8. `MULTIPLE_SEARCH_RESULTS_FOUND`: 多个搜索结果
9. `BUG_REPORT_REQUIRED`: 需要bug报告
10. `INVALID_RESPONSE_FORMAT`: 无效响应格式
11. `INVALID_TOOL_NAME`: 无效工具名称

每种错误都有相应的处理策略和重试机制。

---

## 📈 性能优化

1. **思维链截断**: 只保留最近30条完整观察，减少token消耗
2. **字符串截断**: 大文件内容自动截断，避免超出上下文限制
3. **延迟重试**: 失败后使用指数退避策略
4. **模型切换**: 根据错误类型和重复次数智能切换模型

---

## 🚀 未来扩展

- [ ] 支持更多编程语言
- [ ] 增加代码审查功能
- [ ] 支持并行工具调用
- [ ] 增加更多LLM模型支持
- [ ] 优化模式提取算法
- [ ] 增加可视化界面

---

## 📄 许可证

（根据项目实际情况填写）

---

## 👥 贡献者

（根据项目实际情况填写）

---

*最后更新: 2025年*